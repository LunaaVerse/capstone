<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style1.css" />
    <link rel="stylesheet" href="css/viewprofile.css" />
    <title>LGU4 - Accident & Violation Reports</title>
    <style>
      /* Accident & Violation Reports Specific Styles */
      .report-status-card {
        border-left: 4px solid;
        transition: all 0.3s;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      
      .report-status-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      
      .status-pending {
        border-left-color: #ffd166;
        background: linear-gradient(to right, rgba(255, 209, 102, 0.05), white);
      }
      
      .status-verified {
        border-left-color: #06d6a0;
        background: linear-gradient(to right, rgba(6, 214, 160, 0.05), white);
      }
      
      .status-invalid {
        border-left-color: #e63946;
        background: linear-gradient(to right, rgba(230, 57, 70, 0.05), white);
      }
      
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }
      
      .indicator-pending {
        background-color: #ffd166;
      }
      
      .indicator-verified {
        background-color: #06d6a0;
      }
      
      .indicator-invalid {
        background-color: #e63946;
      }
      
      .report-form {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border-top: 3px solid #1d3557;
      }
      
      .report-table {
        max-height: 500px;
        overflow-y: auto;
      }
      
      .tab-content {
        padding: 20px;
        background: white;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      }
      
      .tab-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      
      .tab-button {
        padding: 10px 20px;
        background: #f8f9fa;
        border: none;
        border-radius: 5px 5px 0 0;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .tab-button:hover {
        background: #e9ecef;
      }
      
      .tab-button.active {
        background: #1d3557;
        color: white;
      }
      
      .image-preview {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 10px;
      }
      
      .admin-actions {
        display: flex;
        gap: 5px;
      }
      
      .admin-actions .btn {
        padding: 5px 10px;
        font-size: 12px;
      }
      
      .report-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
      }
      
      .modal-image {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
      }
    </style>
  </head>
  <body>
    <div id="avatarModal" class="modal">
      <span class="close">&times;</span>
      <img class="modal-content" id="modalImage" />
    </div>

    <!-- Image Preview Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Report Image</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img id="modalReportImage" class="modal-image" />
          </div>
        </div>
      </div>
    </div>

    <section id="sidebar">
      <a href="#" class="brand">
        <img
          src="img/ttm.png"
          alt="Profile Photo"
          class="profile-avatar"
          id="profileAvatar"
          style="cursor: pointer; transition: transform 0.2s"
        />
        <span class="text">Traffic And Transport Management</span>
      </a>
      <ul class="side-menu top">
        <li>
          <a href="index.html">
            <i class="bx bxs-dashboard"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <span class="separator">Main</span>
        
        <li>
          <a href="../TM/index.html">
            <i class="bx bx-car"></i>
            <span class="text">Traffic Monitoring (CCTV) </span>
          </a>
        </li>
        <li>
          <a href="../RTR/index.html">
            <i class="bx bx-flame"></i>
            <span class="text">Real-Time Road Updates</span>
          </a>
        </li>
        <li class="active">
          <a href="#">
            <i class="bx bx-bell"></i>
            <span class="text"> Accident & Violation Reports </span>
          </a>
        </li>
        <li>
          <a href="../VRD/index.html">
            <i class="bx bx-user"></i>
            <span class="text">Vehicle Routing & Diversion</span>
          </a>
        </li>
        <li>
          <a href="../TSC/index.html">
            <i class="bx bx-bar-chart-big"></i>
            <span class="text"> Traffic Signal Control</span>
          </a>
        </li>
        <li>
          <a href="../PTS/index.html">
            <i class="bx bx-megaphone-alt"></i>
            <span class="text">Public Transport Sync </span>
          </a>
        </li>
        <li>
          <a href="../PATS/index.html">
            <i class="bx bx-heart-plus"></i>
            <span class="text">Permit & Ticketing System</span>
          </a>
        </li>
        
      </ul>
      <ul class="side-menu">
        <span class="separator">SETTINGS</span>
        <li>
          <a href="Profile.html">
            <i class="bx bxs-user-pin"></i>
            <span class="text">Profile</span>
          </a>
        </li>
        <li>
          <a href="Settings.html">
            <i class="bx bxs-cog"></i>
            <span class="text">Settings</span>
          </a>
        </li>
        <li>
          <a href="#" class="logout">
            <i class="bx bxs-log-out-circle"></i>
            <span class="text">Logout</span>
          </a>
        </li>
      </ul>
    </section>

    <section id="content">
      <nav>
        <a href="#" class="nav-link">Categories</a>
        <form action="#">
          <div class="form-input">
            <input type="search" placeholder="Search..." />
            <button type="submit" class="search-btn">
              <i class="bx bx-search"></i>
            </button>
          </div>
        </form>
        <a href="#" class="notification">
          <i class="bx bxs-bell"></i>
          <span class="num">9+</span>
        </a>
        <div class="profile-dropdown">
          <a href="#" class="profile" id="profile-btn">
            <img src="img/aiah.jpg" />
          </a>
          <div class="dropdown-menu" id="dropdown-menu">
            <a href="Profile.html">Profile</a>
            <a href="Settings.html">Settings</a>
          </div>
        </div>
      </nav>

      <main>
        <div class="head-title">
          <div class="left">
            <h1>Accident & Violation Reports</h1>
            <ul class="breadcrumb">
              <li>
                <a href="#">Dashboard</a>
              </li>
              <li><i class="bx bx-chevron-right"></i></li>
              <li>
                <a class="active" href="#">Accident & Violation Reports</a>
              </li>
            </ul>
          </div>
        </div>
        
        <div class="tab-buttons">
          <button class="tab-button active" onclick="openTab(event, 'user_report_form')">
            <i class="bx bx-edit"></i> Submit Report
          </button>
          <button class="tab-button" onclick="openTab(event, 'admin_review')">
            <i class="bx bx-check-shield"></i> Admin Review
          </button>
          <button class="tab-button" onclick="openTab(event, 'violation_history')">
            <i class="bx bx-history"></i> Report History
          </button>
          <button class="tab-button" onclick="openTab(event, 'dashboard')">
            <i class="bx bxs-dashboard"></i> Dashboard
          </button>
        </div>
        
        <!-- User Report Form Tab -->
        <div id="user_report_form" class="tab-content" style="display: block;">
          <div class="row">
            <div class="col-md-8">
              <div class="report-form">
                <h4><i class="bx bx-edit"></i> Submit Accident/Violation Report</h4>
                <form id="reportForm">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Report Type</label>
                      <select class="form-select" id="reportType" required>
                        <option value="">Select report type</option>
                        <option value="accident">Traffic Accident</option>
                        <option value="violation">Traffic Violation</option>
                        <option value="hazard">Road Hazard</option>
                        <option value="other">Other</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Priority Level</label>
                      <select class="form-select" id="priorityLevel" required>
                        <option value="">Select priority</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="reportLocation" placeholder="Enter specific location or intersection" required>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Date</label>
                      <input type="date" class="form-control" id="reportDate" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Time</label>
                      <input type="time" class="form-control" id="reportTime" required>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="reportDescription" rows="4" placeholder="Provide detailed description of the incident" required></textarea>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Upload Image (Optional)</label>
                    <input type="file" class="form-control" id="reportImage" accept="image/*">
                    <div id="imagePreview"></div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label">Reporter Information</label>
                    <div class="row">
                      <div class="col-md-6">
                        <input type="text" class="form-control" id="reporterName" placeholder="Your name" required>
                      </div>
                      <div class="col-md-6">
                        <input type="email" class="form-control" id="reporterEmail" placeholder="Your email">
                      </div>
                    </div>
                  </div>
                  
                  <button type="submit" class="btn btn-primary">
                    <i class="bx bx-send"></i> Submit Report
                  </button>
                  <button type="reset" class="btn btn-outline-secondary ms-2">
                    <i class="bx bx-reset"></i> Reset Form
                  </button>
                </form>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="report-form">
                <h4><i class="bx bx-info-circle"></i> Reporting Guidelines</h4>
                <div class="alert alert-info">
                  <h6>Before submitting:</h6>
                  <ul class="mb-0">
                    <li>Ensure your safety first</li>
                    <li>Provide accurate location details</li>
                    <li>Include clear photos if possible</li>
                    <li>Be specific in your description</li>
                  </ul>
                </div>
                
                <div class="alert alert-warning">
                  <h6>Emergency Situations:</h6>
                  <p class="mb-0">For immediate emergencies, call <strong>911</strong> or local emergency services before submitting this report.</p>
                </div>
                
                <div class="mt-3">
                  <h6>Report Status Meanings:</h6>
                  <div class="mb-2">
                    <span class="status-indicator indicator-pending"></span>
                    <small>Pending - Under review</small>
                  </div>
                  <div class="mb-2">
                    <span class="status-indicator indicator-verified"></span>
                    <small>Verified - Confirmed and processed</small>
                  </div>
                  <div class="mb-2">
                    <span class="status-indicator indicator-invalid"></span>
                    <small>Invalid - Requires more information</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Admin Review Tab -->
        <div id="admin_review" class="tab-content" style="display: none;">
          <div class="row">
            <div class="col-md-12">
              <div class="report-form">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h4><i class="bx bx-check-shield"></i> Admin Review Dashboard</h4>
                  <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="filterByStatus('pending')">
                      <i class="bx bx-time"></i> Pending Only
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="loadAdminReports()">
                      <i class="bx bx-refresh"></i> Refresh
                    </button>
                  </div>
                </div>
                
                <div class="report-table">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th>Date/Time</th>
                        <th>Reporter</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Image</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="adminReportsTable">
                      <!-- Reports will be populated here -->
                    </tbody>
                  </table>
                </div>
                
                <div class="alert alert-info mt-3">
                  <i class="bx bx-info-circle"></i> Click on report actions to approve, flag, or reject reports.
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Violation History Tab -->
        <div id="violation_history" class="tab-content" style="display: none;">
          <div class="row">
            <div class="col-md-12">
              <div class="report-form">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h4><i class="bx bx-history"></i> Report History</h4>
                  <div>
                    <input type="text" class="form-control d-inline-block" id="searchHistory" placeholder="Search reports..." style="width: 200px;">
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="searchReports()">
                      <i class="bx bx-search"></i> Search
                    </button>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="exportHistoryToPDF()">
                      <i class="bx bx-download"></i> Export PDF
                    </button>
                  </div>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-3">
                    <select class="form-select" id="filterType">
                      <option value="">All Types</option>
                      <option value="accident">Accidents</option>
                      <option value="violation">Violations</option>
                      <option value="hazard">Hazards</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" id="filterStatus">
                      <option value="">All Status</option>
                      <option value="pending">Pending</option>
                      <option value="verified">Verified</option>
                      <option value="invalid">Invalid</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <input type="date" class="form-control" id="filterDate" placeholder="Filter by date">
                  </div>
                  <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" onclick="applyFilters()">
                      <i class="bx bx-filter"></i> Apply Filters
                    </button>
                  </div>
                </div>
                
                <div class="report-table">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th>Date/Time</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Description</th>
                        <th>Image</th>
                      </tr>
                    </thead>
                    <tbody id="historyTable">
                      <!-- History will be populated here -->
                    </tbody>
                  </table>
                </div>
                
                <div class="alert alert-info mt-3">
                  <i class="bx bx-info-circle"></i> Showing all submitted reports with their current status.
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content" style="display: none;">
          <div class="dashboard-overview">
            <h2>Reports Dashboard Overview</h2>
            
            <div class="stats-container">
              <div class="stat-card">
                <h3>Total Reports</h3>
                <p id="totalReports">0</p>
              </div>
              <div class="stat-card">
                <h3>Pending Review</h3>
                <p id="pendingReports">0</p>
              </div>
              <div class="stat-card">
                <h3>Verified Reports</h3>
                <p id="verifiedReports">0</p>
              </div>
              <div class="stat-card">
                <h3>This Month</h3>
                <p id="monthlyReports">0</p>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-md-6">
                <div class="report-status-card status-pending p-3 mb-3">
                  <h5>Recent Pending Reports</h5>
                  <div id="recentPending">
                    <p class="mb-0">No pending reports</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="report-status-card status-verified p-3 mb-3">
                  <h5>Recently Verified</h5>
                  <div id="recentVerified">
                    <p class="mb-0">No verified reports</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart">
                <h3>Report Types Distribution</h3>
                <canvas id="reportTypesChart"></canvas>
              </div>
              <div class="chart">
                <h3>Monthly Report Trends</h3>
                <canvas id="monthlyTrendsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </main>
    </section>
    
    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
      // Tab functionality
      function openTab(evt, tabName) {
        var i, tabcontent, tabbuttons;
        
        // Hide all tab content
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        
        // Remove active class from all buttons
        tabbuttons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabbuttons.length; i++) {
          tabbuttons[i].classList.remove("active");
        }
        
        // Show the current tab and add active class to the button
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
        
        // Load data when tabs are clicked
        if(tabName === 'admin_review') {
          loadAdminReports();
        } else if(tabName === 'violation_history') {
          loadReportHistory();
        } else if(tabName === 'dashboard') {
          loadDashboardStats();
          initializeCharts();
        }
      }
      
      // Report Form Handling
      document.getElementById('reportForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form values
        const reportData = {
          id: 'RPT' + Date.now(),
          type: document.getElementById('reportType').value,
          priority: document.getElementById('priorityLevel').value,
          location: document.getElementById('reportLocation').value,
          date: document.getElementById('reportDate').value,
          time: document.getElementById('reportTime').value,
          description: document.getElementById('reportDescription').value,
          reporterName: document.getElementById('reporterName').value,
          reporterEmail: document.getElementById('reporterEmail').value,
          status: 'pending',
          timestamp: new Date().getTime(),
          image: null
        };
        
        // Handle image upload
        const imageFile = document.getElementById('reportImage').files[0];
        if (imageFile) {
          const reader = new FileReader();
          reader.onload = function(e) {
            reportData.image = e.target.result;
            saveReport(reportData);
          };
          reader.readAsDataURL(imageFile);
        } else {
          saveReport(reportData);
        }
      });
      
      // Save report to localStorage
      function saveReport(reportData) {
        let reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        reports.push(reportData);
        localStorage.setItem('accidentReports', JSON.stringify(reports));
        
        // Reset form
        document.getElementById('reportForm').reset();
        document.getElementById('imagePreview').innerHTML = '';
        
        // Show success message
        alert('Report submitted successfully! Report ID: ' + reportData.id);
      }
      
      // Image preview functionality
      document.getElementById('reportImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('imagePreview');
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="Preview">`;
          };
          reader.readAsDataURL(file);
        } else {
          preview.innerHTML = '';
        }
      });
      
      // Load admin reports
      function loadAdminReports() {
        const reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        const adminTable = document.getElementById('adminReportsTable');
        adminTable.innerHTML = '';
        
        if(reports.length === 0) {
          adminTable.innerHTML = '<tr><td colspan="9" class="text-center">No reports available</td></tr>';
          return;
        }
        
        // Sort by timestamp (newest first)
        const sortedReports = reports.sort((a, b) => b.timestamp - a.timestamp);
        
        sortedReports.forEach(report => {
          const row = document.createElement('tr');
          
          let statusBadge = '';
          if(report.status === 'pending') {
            statusBadge = '<span class="badge bg-warning">Pending</span>';
          } else if(report.status === 'verified') {
            statusBadge = '<span class="badge bg-success">Verified</span>';
          } else {
            statusBadge = '<span class="badge bg-danger">Invalid</span>';
          }
          
          let priorityBadge = '';
          if(report.priority === 'critical') {
            priorityBadge = '<span class="badge bg-danger">Critical</span>';
          } else if(report.priority === 'high') {
            priorityBadge = '<span class="badge bg-warning">High</span>';
          } else if(report.priority === 'medium') {
            priorityBadge = '<span class="badge bg-info">Medium</span>';
          } else {
            priorityBadge = '<span class="badge bg-secondary">Low</span>';
          }
          
          const imageCell = report.image ? 
            `<img src="${report.image}" class="report-image" onclick="showImageModal('${report.image}')" alt="Report image">` : 
            '<span class="text-muted">No image</span>';
          
          row.innerHTML = `
            <td>${report.id}</td>
            <td>${report.type}</td>
            <td>${report.location}</td>
            <td>${report.date} ${report.time}</td>
            <td>${report.reporterName}</td>
            <td>${priorityBadge}</td>
            <td>${statusBadge}</td>
            <td>${imageCell}</td>
            <td>
              <div class="admin-actions">
                <button class="btn btn-success btn-sm" onclick="updateReportStatus('${report.id}', 'verified')" ${report.status === 'verified' ? 'disabled' : ''}>
                  <i class="bx bx-check"></i>
                </button>
                <button class="btn btn-warning btn-sm" onclick="updateReportStatus('${report.id}', 'pending')" ${report.status === 'pending' ? 'disabled' : ''}>
                  <i class="bx bx-time"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="updateReportStatus('${report.id}', 'invalid')" ${report.status === 'invalid' ? 'disabled' : ''}>
                  <i class="bx bx-x"></i>
                </button>
              </div>
            </td>
          `;
          
          adminTable.appendChild(row);
        });
      }
      
      // Update report status
      function updateReportStatus(reportId, newStatus) {
        let reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        const reportIndex = reports.findIndex(r => r.id === reportId);
        
        if (reportIndex !== -1) {
          reports[reportIndex].status = newStatus;
          reports[reportIndex].reviewedAt = new Date().getTime();
          localStorage.setItem('accidentReports', JSON.stringify(reports));
          
          // Reload admin reports
          loadAdminReports();
          
          // Show success message
          alert(`Report ${reportId} status updated to ${newStatus}`);
        }
      }
      
      // Load report history
      function loadReportHistory() {
        const reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        const historyTable = document.getElementById('historyTable');
        historyTable.innerHTML = '';
        
        if(reports.length === 0) {
          historyTable.innerHTML = '<tr><td colspan="8" class="text-center">No reports available</td></tr>';
          return;
        }
        
        // Sort by timestamp (newest first)
        const sortedReports = reports.sort((a, b) => b.timestamp - a.timestamp);
        
        sortedReports.forEach(report => {
          const row = document.createElement('tr');
          
          let statusText = '';
          if(report.status === 'pending') {
            statusText = '<span class="status-indicator indicator-pending"></span> Pending';
          } else if(report.status === 'verified') {
            statusText = '<span class="status-indicator indicator-verified"></span> Verified';
          } else {
            statusText = '<span class="status-indicator indicator-invalid"></span> Invalid';
          }
          
          let priorityBadge = '';
          if(report.priority === 'critical') {
            priorityBadge = '<span class="badge bg-danger">Critical</span>';
          } else if(report.priority === 'high') {
            priorityBadge = '<span class="badge bg-warning">High</span>';
          } else if(report.priority === 'medium') {
            priorityBadge = '<span class="badge bg-info">Medium</span>';
          } else {
            priorityBadge = '<span class="badge bg-secondary">Low</span>';
          }
          
          const imageCell = report.image ? 
            `<img src="${report.image}" class="report-image" onclick="showImageModal('${report.image}')" alt="Report image">` : 
            '<span class="text-muted">No image</span>';
          
          row.innerHTML = `
            <td>${report.id}</td>
            <td>${report.type}</td>
            <td>${report.location}</td>
            <td>${report.date} ${report.time}</td>
            <td>${statusText}</td>
            <td>${priorityBadge}</td>
            <td>${report.description.substring(0, 50)}...</td>
            <td>${imageCell}</td>
          `;
          
          historyTable.appendChild(row);
        });
      }
      
      // Show image modal
      function showImageModal(imageSrc) {
        document.getElementById('modalReportImage').src = imageSrc;
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
      }
      
      // Filter functions
      function filterByStatus(status) {
        const reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        const filteredReports = reports.filter(r => r.status === status);
        displayFilteredReports(filteredReports);
      }
      
      function applyFilters() {
        const reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        const typeFilter = document.getElementById('filterType').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const dateFilter = document.getElementById('filterDate').value;
        
        let filteredReports = reports;
        
        if (typeFilter) {
          filteredReports = filteredReports.filter(r => r.type === typeFilter);
        }
        
        if (statusFilter) {
          filteredReports = filteredReports.filter(r => r.status === statusFilter);
        }
        
        if (dateFilter) {
          filteredReports = filteredReports.filter(r => r.date === dateFilter);
        }
        
        displayFilteredHistoryReports(filteredReports);
      }
      
      function displayFilteredReports(reports) {
        const adminTable = document.getElementById('adminReportsTable');
        adminTable.innerHTML = '';
        
        if(reports.length === 0) {
          adminTable.innerHTML = '<tr><td colspan="9" class="text-center">No reports match the filter</td></tr>';
          return;
        }
        
        // Similar to loadAdminReports but with filtered data
        reports.forEach(report => {
          // Same row creation logic as in loadAdminReports
          const row = document.createElement('tr');
          
          let statusBadge = '';
          if(report.status === 'pending') {
            statusBadge = '<span class="badge bg-warning">Pending</span>';
          } else if(report.status === 'verified') {
            statusBadge = '<span class="badge bg-success">Verified</span>';
          } else {
            statusBadge = '<span class="badge bg-danger">Invalid</span>';
          }
          
          let priorityBadge = '';
          if(report.priority === 'critical') {
            priorityBadge = '<span class="badge bg-danger">Critical</span>';
          } else if(report.priority === 'high') {
            priorityBadge = '<span class="badge bg-warning">High</span>';
          } else if(report.priority === 'medium') {
            priorityBadge = '<span class="badge bg-info">Medium</span>';
          } else {
            priorityBadge = '<span class="badge bg-secondary">Low</span>';
          }
          
          const imageCell = report.image ? 
            `<img src="${report.image}" class="report-image" onclick="showImageModal('${report.image}')" alt="Report image">` : 
            '<span class="text-muted">No image</span>';
          
          row.innerHTML = `
            <td>${report.id}</td>
            <td>${report.type}</td>
            <td>${report.location}</td>
            <td>${report.date} ${report.time}</td>
            <td>${report.reporterName}</td>
            <td>${priorityBadge}</td>
            <td>${statusBadge}</td>
            <td>${imageCell}</td>
            <td>
              <div class="admin-actions">
                <button class="btn btn-success btn-sm" onclick="updateReportStatus('${report.id}', 'verified')" ${report.status === 'verified' ? 'disabled' : ''}>
                  <i class="bx bx-check"></i>
                </button>
                <button class="btn btn-warning btn-sm" onclick="updateReportStatus('${report.id}', 'pending')" ${report.status === 'pending' ? 'disabled' : ''}>
                  <i class="bx bx-time"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="updateReportStatus('${report.id}', 'invalid')" ${report.status === 'invalid' ? 'disabled' : ''}>
                  <i class="bx bx-x"></i>
                </button>
              </div>
            </td>
          `;
          
          adminTable.appendChild(row);
        });
      }
      
      function displayFilteredHistoryReports(reports) {
        const historyTable = document.getElementById('historyTable');
        historyTable.innerHTML = '';
        
        if(reports.length === 0) {
          historyTable.innerHTML = '<tr><td colspan="8" class="text-center">No reports match the filter</td></tr>';
          return;
        }
        
        reports.forEach(report => {
          const row = document.createElement('tr');
          
          let statusText = '';
          if(report.status === 'pending') {
            statusText = '<span class="status-indicator indicator-pending"></span> Pending';
          } else if(report.status === 'verified') {
            statusText = '<span class="status-indicator indicator-verified"></span> Verified';
          } else {
            statusText = '<span class="status-indicator indicator-invalid"></span> Invalid';
          }
          
          let priorityBadge = '';
          if(report.priority === 'critical') {
            priorityBadge = '<span class="badge bg-danger">Critical</span>';
          } else if(report.priority === 'high') {
            priorityBadge = '<span class="badge bg-warning">High</span>';
          } else if(report.priority === 'medium') {
            priorityBadge = '<span class="badge bg-info">Medium</span>';
          } else {
            priorityBadge = '<span class="badge bg-secondary">Low</span>';
          }
          
          const imageCell = report.image ? 
            `<img src="${report.image}" class="report-image" onclick="showImageModal('${report.image}')" alt="Report image">` : 
            '<span class="text-muted">No image</span>';
          
          row.innerHTML = `
            <td>${report.id}</td>
            <td>${report.type}</td>
            <td>${report.location}</td>
            <td>${report.date} ${report.time}</td>
            <td>${statusText}</td>
            <td>${priorityBadge}</td>
            <td>${report.description.substring(0, 50)}...</td>
            <td>${imageCell}</td>
          `;
          
          historyTable.appendChild(row);
        });
      }
      
      // Search reports
      function searchReports() {
        const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
        const reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        
        const filteredReports = reports.filter(report => 
          report.location.toLowerCase().includes(searchTerm) ||
          report.description.toLowerCase().includes(searchTerm) ||
          report.type.toLowerCase().includes(searchTerm) ||
          report.reporterName.toLowerCase().includes(searchTerm)
        );
        
        displayFilteredHistoryReports(filteredReports);
      }
      
      // Export to PDF
      function exportHistoryToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(18);
        doc.text('Accident & Violation Reports History', 14, 15);
        
        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);
        
        // Get data from localStorage
        const reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        
        if (reports.length === 0) {
          doc.text('No reports available', 14, 35);
          doc.save('accident_violation_reports.pdf');
          return;
        }
        
        // Prepare data for table
        const headers = ['ID', 'Type', 'Location', 'Date', 'Status', 'Priority', 'Description'];
        const rows = reports.map(report => [
          report.id,
          report.type,
          report.location,
          report.date,
          report.status,
          report.priority,
          report.description.substring(0, 50) + '...'
        ]);
        
        // Add table to PDF
        doc.autoTable({
          head: [headers],
          body: rows,
          startY: 30,
          styles: {
            fontSize: 8,
            cellPadding: 2
          },
          headStyles: {
            fillColor: [29, 53, 87],
            textColor: 255
          }
        });
        
        // Save the PDF
        doc.save('accident_violation_reports.pdf');
      }
      
      // Load dashboard statistics
      function loadDashboardStats() {
        const reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        
        // Calculate statistics
        const totalReports = reports.length;
        const pendingReports = reports.filter(r => r.status === 'pending').length;
        const verifiedReports = reports.filter(r => r.status === 'verified').length;
        
        // Calculate monthly reports (current month)
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        const monthlyReports = reports.filter(r => {
          const reportDate = new Date(r.date);
          return reportDate.getMonth() === currentMonth && reportDate.getFullYear() === currentYear;
        }).length;
        
        // Update dashboard stats
        document.getElementById('totalReports').textContent = totalReports;
        document.getElementById('pendingReports').textContent = pendingReports;
        document.getElementById('verifiedReports').textContent = verifiedReports;
        document.getElementById('monthlyReports').textContent = monthlyReports;
        
        // Update recent reports sections
        const recentPending = reports.filter(r => r.status === 'pending').slice(0, 3);
        const recentVerified = reports.filter(r => r.status === 'verified').slice(0, 3);
        
        const pendingDiv = document.getElementById('recentPending');
        const verifiedDiv = document.getElementById('recentVerified');
        
        if (recentPending.length > 0) {
          pendingDiv.innerHTML = recentPending.map(r => 
            `<small class="d-block">${r.type} - ${r.location}</small>`
          ).join('');
        }
        
        if (recentVerified.length > 0) {
          verifiedDiv.innerHTML = recentVerified.map(r => 
            `<small class="d-block">${r.type} - ${r.location}</small>`
          ).join('');
        }
      }
      
      // Initialize charts
      function initializeCharts() {
        const reports = JSON.parse(localStorage.getItem('accidentReports')) || [];
        
        // Report Types Chart
        const typesCtx = document.getElementById('reportTypesChart').getContext('2d');
        const typeCounts = {
          accident: reports.filter(r => r.type === 'accident').length,
          violation: reports.filter(r => r.type === 'violation').length,
          hazard: reports.filter(r => r.type === 'hazard').length,
          other: reports.filter(r => r.type === 'other').length
        };
        
        new Chart(typesCtx, {
          type: 'doughnut',
          data: {
            labels: ['Accidents', 'Violations', 'Hazards', 'Other'],
            datasets: [{
              data: [typeCounts.accident, typeCounts.violation, typeCounts.hazard, typeCounts.other],
              backgroundColor: [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
        
        // Monthly Trends Chart
        const trendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
        const monthlyData = Array(12).fill(0);
        
        reports.forEach(report => {
          const month = new Date(report.date).getMonth();
          monthlyData[month]++;
        });
        
        new Chart(trendsCtx, {
          type: 'line',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
              label: 'Reports per Month',
              data: monthlyData,
              borderColor: 'rgb(29, 53, 87)',
              backgroundColor: 'rgba(29, 53, 87, 0.1)',
              tension: 0.1,
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }
      
      // Profile dropdown functionality
      document.getElementById("profile-btn").addEventListener("click", function (event) {
        event.preventDefault();
        document.getElementById("dropdown-menu").classList.toggle("show");
      });
      
      document.addEventListener("click", function (event) {
        if (!document.getElementById("profile-btn").contains(event.target)) {
          document.getElementById("dropdown-menu").classList.remove("show");
        }
      });
      
      // Avatar modal functionality
      var modal = document.getElementById("avatarModal");
      var img = document.getElementById("profileAvatar");
      var modalImg = document.getElementById("modalImage");
      
      img.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
      };
      
      var span = document.getElementsByClassName("close")[0];
      span.onclick = function () {
        modal.style.display = "none";
      };
      
      modal.onclick = function (event) {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };
      
      // Avatar click animation
      document.getElementById("profileAvatar").addEventListener("click", function () {
        this.style.transform = "scale(0.95)";
        setTimeout(() => {
          this.style.transform = "scale(1)";
        }, 200);
      });
      
      // Set current date as default
      document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reportDate').value = today;
        
        const now = new Date().toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('reportTime').value = now;
      });
    </script>
  </body>
</html>